{% extends "base.html" %}
{% block content %}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Inicio</a></li>
        <li class="breadcrumb-item active"  aria-current="page">Condóminos</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-secondary"><i class="fa-solid fa-users-gear"></i> Gestión de Condóminos</h2>
    
    <div class="d-flex gap-2">
        <a href="{{ url_for('condominos.nuevo_departamento') }}" class="btn btn-success shadow-sm">
            <i class="fa-solid fa-plus"></i> Nuevo Departamento
        </a>
        <form action="{{ url_for('condominos.generar_mensualidad') }}" method="POST" onsubmit="return confirm('¿Deseas generar los cargos de expensas para todos los departamentos este mes?');">
            <button type="submit" class="btn btn-warning shadow-sm">
                <i class="fa-solid fa-file-invoice-dollar"></i> Generar Expensas del Mes
            </button>
        </form>
    </div>
</div>

<div class="row row-cols-1 row-cols-lg-2 g-4">
    {% for d in departamentos %}
    <div class="col">
        <div class="card h-100 shadow-sm border-0 border-start border-4 {% if d.esta_arrendado %}border-warning{% else %}border-info{% endif %} hover-effect">
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-4 text-center border-end">
                        <h1 class="display-4 fw-bold text-primary mb-0">{{ d.numero }}</h1>
                        <span class="badge bg-light text-dark border mb-2">Piso {{ d.piso }}</span>
                        
                        <div class="mt-2 py-2 rounded bg-light border">
                            <small class="text-muted d-block">Saldo Pendiente</small>
                            <span class="fs-4 fw-bold {% if d.saldo_pendiente > 0 %}text-danger{% else %}text-success{% endif %}">
                                ${{ "%.2f"|format(d.saldo_pendiente) }}
                            </span>
                        </div>

                        <div class="mt-3">
                             {% if d.esta_arrendado %}
                                <span class="text-warning small fw-bold"><i class="fa-solid fa-key"></i> ARRENDADO</span>
                            {% else %}
                                <span class="text-info small fw-bold"><i class="fa-solid fa-house-user"></i> HABITADO</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-sm-8 ps-lg-4">
                        {% set propietario = d.personas|selectattr("rol", "equalto", "PROPIETARIO")|list|first if d.personas else None %}
                        
                        <div class="mb-2">
                            <small class="text-muted text-uppercase d-block">Propietario</small>
                            <h5 class="fw-bold mb-0">
                                {{ propietario.nombre if propietario else "Sin asignar" }}
                            </h5>
                        </div>

                        <div class="row mb-3">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block">Expensa Fija</small>
                                <span class="fw-bold fs-5 text-success">${{ "%.2f"|format(d.valor_expensa) }}</span>
                            </div>
                            <div class="col-8">
                                <small class="text-muted d-block">Paga</small>
                                <span class="fw-bold text-uppercase">{{ d.responsable_pago }}</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block">Teléfono</small>
                                <span class="text-muted d-block">{{ propietario.telefono if propietario else "-" }}</span>
                            </div>
                            <div class="col-8">
                                <small class="text-muted d-block">Correo</small>
                                <span class="text-muted d-block">{{ propietario.email if propietario else "-" }}</span>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center bg-light p-2 rounded">
                            <div class="btn-group">
                                <a href="{{ url_for('condominos.estado_cuenta', id=d.id) }}" class="btn btn-outline-dark btn-sm shadow-sm" title="Ver historial">
                                    <i class="fa-solid fa-list-check"></i> 
                                </a>
                                
                                {# Lógica de Aviso de Cobro #}
                                {% set ultimo_pendiente = d.pagos|selectattr("estado", "equalto", "PENDIENTE")|sort(attribute='fecha_emision', reverse=True)|first %}
                            
                                {% if ultimo_pendiente %}
                                    {% if ultimo_pendiente.comprobante %}
                                        <a href="{{ url_for('static', filename='uploads/avisos/' + ultimo_pendiente.comprobante) }}" target="_blank" class="btn btn-outline-danger btn-sm shadow-sm">
                                            <i class="fa-solid fa-file-pdf"></i> 
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('condominos.reimprimir_aviso', movimiento_id=ultimo_pendiente.id) }}" target="_blank" class="btn btn-outline-secondary btn-sm shadow-sm">
                                            <i class="fa-solid fa-print"></i> 
                                        </a>
                                    {% endif %}

                                    {# NUEVO: Botón de WhatsApp utilizando la función de utils.py #}
                                    {% if propietario and propietario.telefono and d.saldo_pendiente > 0 %}
                                        <a href="{{ generar_link_whatsapp(propietario, d, d.saldo_pendiente) }}" 
                                        target="_blank" 
                                        class="btn btn-outline-success btn-sm shadow-sm" 
                                        title="Cobrar por WhatsApp">
                                            <i class="fa-brands fa-whatsapp"></i>
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <a href="{{ url_for('condominos.editar_departamento', id=d.id) }}" class="btn btn-primary btn-sm shadow-sm">
                                <i class="fa-solid fa-user-pen"></i> Editar Info
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<style>
    .hover-effect {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-effect:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
</style>
{% endblock %}